#!/usr/bin/expect -f
set timeout -1
#spawn ./ta-test
#send -- "he\n";
source config.expect

set nomonster 1

proc start_timer { secs } {
        puts "Starting timer for $secs seconds\n"
        set then [ clock seconds ]
        set now $then
        set diff [expr $now - $then]
        while {$diff < $secs } {
                set now [clock seconds];
                set diff [expr $now - $then]
        }
}


proc connect {} {
	global spawn_id
	global username
	global password
	spawn telnet tdod.org 3000
	set count 0
	expect {
		"User-ID" {
			if { $count > 0 } {
				start_timer 2
			}
			send -- "$username\r\n"; 
			incr count 1; 
			exp_continue
		}
		"password:" { send -- "$password\r\n"; exp_continue }
		"Press ENTER to continue)" { send -- "\n"; exp_continue }
		"Multi-User Games" { send -- "\ng\r\n"; exp_continue }
		"Trivia Top Ten" { send -- "\n"; exp_continue }
		"1,2,3,4,5,7,8,9,0,B,C,D,E,F,G,H,I,J,L,M,N,O" { send -- "\n3\r\n"; }
		"(C)ontinue" { send -- "\n"; exp_continue }
	}
}

proc connect_test {} {
	global spawn_id
	spawn ./ta-test
}


proc disconnect {} {
	close
	exit
}

proc whereami {} {
	global location
	puts "--Getting location\n"
	send "\r\n"
	expect -re {You\'re in the ([a-z ]*)\.} {
		set location $expect_out(1,string)
	}
	puts "--Location: $location\n"
}

proc get_monsters {} {
	global monster;
	global nomonster;
	send "\r\n";
	expect { 
		-re {There is (a|an|are) (two |three |four )?([a-z]*)s? here} {
			set monster $expect_out(3,string);
			set nomonster 0;
			puts "Found a $monster!"
		}
		"nobody" {
			set monster ""
			set nomonster 1;
		}
	}
	puts "Monster:$monster; nomonster:$nomonster\n";
}

proc travel { from to } {
	if { $from == "arena" && $to == "tavern" } { send -- "w\r\nne\r\n" }
	if { $from == "temple" && $to == "arena" } { send -- "e\r\ne\r\n" }
	if { $from == "north plaza" && $to == "tavern" } { send -- "ne\r\n" }
	if { $from == "arena" && $to == "temple" } { send -- "w\r\nw\r\n" }
	if { $from == "north plaza" && $to == "arena" } { send -- "e\r\n" }
	if { $from == "north plaza" && $to == "temple" } { send -- "w\r\n" }
	if { $from == "tavern" && $to == "arena" } { send -- "sw\r\ne\r\n" }
	if { $from == "north plaza" && $to == "tavern" } { send -- "ne\r\n" }
	if { $from == "temple" && $to == "tavern" } { send -- "e\r\nne\r\n" }
	if { $from == "tavern" && $to == "north plaza" } { send -- "sw\r\n" }
	if { $from == "tavern" && $to == "temple" } { send -- "sw\r\nw\r\n" }
        if { $from == "magic shop" && $to == "arena" } { send -- "n\r\nn\r\ne\r\n" }
        if { $from == "arena" && $to == "magic shop" } { send -- "w\r\ns\r\ns\r\n" }
}
	
proc goto { to } {
	global location
	whereami
	travel $location $to
	if { $location == $to } { return }
	expect { 
		"$to" { puts "Made it to $to, continuing." } 
		"rest a while" {
			start_timer 5
			whereami
			travel $location $to
			exp_continue
		} else {
			whereami
			travel $location $to
			exp_continue
			start_timer 5
		}
	}
}


proc get_max_health {} {
	global vitality_max
	global mana_max
        send -- "he\r\n";
        expect -re {Mana: *[0-9]* */ *([0-9]*).*\nVitality: *[0-9]* */ *([0-9]*)} {
		set mana_max $expect_out(1,string)
		set vitality_max $expect_out(2,string)
	}
	puts "max vit: $vitality_max; max mana: $mana_max\n";
}

proc get_health {} {
	global vitality
	global mana
	global status
        send -- "he\r\n";
        expect -re {Mana: *([0-9]*) */ *[0-9]*.*\nVitality: *([0-9]*) */ *[0-9]*.*\nStatus: *([A-Za-z]*)} {
		set mana $expect_out(1,string)
		set vitality $expect_out(2,string)
		set status $expect_out(3,string)
        } 
	puts "V: $vitality; M: $mana; S: $status\n";
}

proc get_drink {} {
	goto tavern
	send -- "b drink\r\n"
}

proc get_meal {} {
	goto tavern
        send -- "b meal\r\n"
}

proc get_healing {} {
	goto temple
	send -- "b healing\r\n"
}

proc check_health {} {
	global vitality
	global mana
	global status
	global spawn_id
	global heal_spell
	global hurt_spell
	global spell
	global location
	get_health
	set count 0
	set returnto $location
	while { $status == "Thirsty" || $status == "Hungry" || $vitality < 55 } {
		if { $count == 0 } {
			whereami
			set returnto $location
			incr count 1
		}
		if { $status == "Thirsty" } {
			get_drink
			start_timer 5
		} elseif { $status == "Hungry" } {
			get_meal
			start_timer 5
		} elseif { $vitality < 55 } {
			get_healing
			start_timer 5
		}
		get_health
	}
	if { $count > 0 } {
		whereami
		if { $returnto != $location } {
			goto $returnto
		}
	}
	if { $vitality > 70 } {
		if { $returnto != $location } { goto $returnto }
		set spell $hurt_spell
	} elseif { $vitality > 55 } {
		if { $returnto != $location } { goto $returnto }
		set spell $heal_spell
	} 
}


proc check_attack_response {} {
	global nomonster
        expect  {
		"Your attack" {
			set nomonster 0;
		}
                "lifeless" {
                        set nomonster 1;
                }
                "don't see" {
                        set nomonster 1;
                }
		"physically exhausted" {
			set nomonster 0;
		}
		"attacked you" {
			set nomonster 0;
		}
		"Sorry, you don't see" {
			set nomonster 1;
		}
        }
}


proc attack { monster } {
	global nomonster
	global spell
	global attacks_per_round
	for { set i 0} { $i < $attacks_per_round } {incr i 1} {
		send -- "a $monster\r\n";
		check_attack_response
	}
	send -- "c $spell $monster\r\n";
}

proc ring_gong {} {
	global nomonster
	global monster
	get_monsters
	if { $nomonster == 1 } {
		send -- "ri g\r\n";
		expect -re {An? .* enters the arena} {
			set response $expect_out(0,string)
		        set monster [ exec echo $response | grep "enters" | cut -d " " -f2  | sed -e "s/ *$//"]
		        puts "\nmonster: $monster"
			set nomonster 0
		}
	}
	start_timer 4
	while { $nomonster == 0 } {
		attack $monster
		check_health
		start_timer 7
		check_health
		start_timer 7			
	}
}

set send_human {.1 .3 1 .05 2}
connect
#connect_test
start_timer 2

whereami
get_max_health
puts "Got max health\n"
check_health
puts "Checked initial health\n"
goto arena

while { 0 == 0 } {
	check_health
	ring_gong
	start_timer 5
	send -- "ep\r\n"
	send -- "i\r\n"
	check_health
	start_timer 10
}

expect eof
